# Myar - A Simple Archive Tool

`myar` 是一个用于模拟 UNIX `ar` 归档工具的程序，实现了基本的文件归档功能。该工具可以快速添加、提取、列出和删除归档文件中的文件，支持元数据的恢复和处理。

其能完全兼容与ar命令的使用，虽然功能较少但可进行进一步的自我定制（虽然还是没有啥用就是了

## 功能

### 1. 快速添加文件
- 使用 `q` 命令快速将指定文件添加到归档文件中。

### 2. 提取文件
- 使用 `x` 命令从归档文件中提取指定文件，使用`xo`支持恢复原始权限和修改时间（mtime）。

### 3. 列出文件
- 使用 `t` 命令列出归档文件中的所有文件名。
- 使用 `tv` 参数时，显示详细信息，包括文件的权限、UID、GID、修改时间和大小。

### 4. 删除文件
- 使用 `d` 命令从归档文件中删除指定文件。

### 5. 追加旧文件
- 使用 `A` 命令快速追加目录中修改时间超过 N 天的所有普通文件。

### 6. 帮助信息
- 使用 `h` 命令显示帮助信息，了解可用的命令和功能。





## 实现方法

`myar` 程序使用了以下系统调用和数据结构：

### 系统调用
- **`read()`**: 从归档文件或标准输入中读取数据。
- **`write()`**: 向归档文件或标准输出中写入数据。
- **`lseek()`**: 在文件中移动文件指针，以便随机访问文件内容。
- **`open()`**: 打开文件，支持不同的模式（只读、写入等）。
- **`close()`**: 关闭文件描述符，释放资源。
- **`stat()`**: 获取文件的元数据，包括权限、大小和修改时间。

### 数据结构
- **`ar_hdr`**: 结构体用于存储每个文件的归档头信息。包括文件名、权限、UID、GID、修改时间和文件大小等字段。具体实现时，确保每个字段的大小符合 UNIX `ar` 格式的要求。

### 功能实现
1. **快速添加文件 (`q`)**
   - 读取文件的元数据（如大小和权限），构建 `ar_hdr`，然后将文件内容和头部信息写入归档文件。确保填充至偶数大小以保证对齐。

2. **提取文件 (`x`)**
   - 根据文件名查找归档中的文件头。如果找到，创建输出文件并将文件内容写入，同时恢复文件的元数据，包括权限和修改时间，依赖于 `restore_file_metadata()` 函数。

3. **列出文件 (`t`)**
   - 循环读取归档文件中的每个文件头。如果设置了详细模式，按照特定格式输出文件的权限、UID、GID、修改时间和文件大小；否则只列出文件名。

4. **删除文件 (`d`)**
   - 创建一个临时文件，将不需要删除的文件复制到临时文件中，最后用临时文件替换原归档文件。确保在替换前先写入魔数以保持格式一致。

5. **追加旧文件 (`A`)**
   - 遍历指定目录，检查每个文件的修改时间，若超过指定天数，则快速添加到归档中。

6. **帮助信息 (`h`)**
   - 输出所有可用命令及其简要说明，帮助用户理解程序的使用方法。

### 注意事项
- 所有的读写操作必须处理错误情况，确保程序的健壮性。
- 程序不支持符号链接，确保在处理文件时跳过符号链接。
- 在处理归档文件时，确保文件头和内容的对齐要求，必要时添加填充字节。
- 所有的权限和修改时间恢复将受到当前 `umask` 的影响。

通过这些方法，`myar` 实现了对文件归档的基本支持，并提供了简单易用的命令行接口。





## 使用方法

### 编译
使用 `Makefile` 编译程序：
```bash
make
```





### 示例命令

1. **创建归档文件**
   ```bash
   myar q archive.a file1.txt

提取文件

- 提取文件并恢复所有元数据：

  bash

  ```bash
  myar xo archive.a file1.txt
  ```

- 提取文件，不恢复元数据：

  bash

  ```bash
  myar x archive.a file1.txt
  ```

列出归档文件中的文件

- 简单列表：

  bash

  ```bash
  myar t archive.a
  ```

- 详细列表：

  ```bash
  myar tv archive.a
  ```

删除文件

```bash
myar d archive.a file1.txt
```

追加旧文件

```bash
myar A archive.a 30
```

获取帮助

```bash
myar h
```

### 注意事项

- 程序在处理归档文件时，不会跟随符号链接。
- 所有文件权限和修改时间的恢复将受到 umask 的影响。